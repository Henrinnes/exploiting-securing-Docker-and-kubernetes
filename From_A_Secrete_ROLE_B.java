package from_a_secret;

import anbxj.AnBx_Debug;
import anbxj.AnBx_Layers;
import anbxj.AnBx_Params;
import anbxj.AnB_Protocol;
import anbxj.AnB_Session;
import anbxj.Crypto_KeyStoreType;
import anbxj.Crypto_ByteArray;
import anbxj.Crypto_HmacPair;
import anbxj.Crypto_SealedPair;
import anbxj.Crypto_KeyPair;

import java.security.KeyPair;
import java.security.PublicKey;
import java.security.SignedObject;
import javax.crypto.SealedObject;
import javax.crypto.SecretKey;
import javax.crypto.spec.DHParameterSpec;

import java.util.Map;

public final class From_A_Secret_ROLE_B extends AnB_Protocol<From_A_Secret_Steps,From_A_Secret_Roles> {

	private static boolean loop = false;
	private static long sessionID = 0;

	// local knowledge - constants
	
	// local vars
	private Crypto_SealedPair VAR_B_R0 = null;
	
	
	public From_A_Secret_ROLE_B(From_A_Secret_Roles role, String name, String sharepath) {
		super();
		this.role = role;
		this.name = name;
		this.sharepath = sharepath;
		if (sessionID < Integer.MAX_VALUE) {
			sessionID++;
		}
	}

	protected void init() {
		// init shared vars
		};

	public void run(Map<String, AnB_Session> lbs, Map<String, String> aliases) {

		this.aliases = aliases;
		
		AnB_Session ROLE_B_channel_ROLE_A = lbs.get("ROLE_A");
		

			try {
				ROLE_B_channel_ROLE_A.Open();
				
				init();
				
				do {
					executeStep(ROLE_B_channel_ROLE_A, From_A_Secret_Steps.STEP_0);
					
				} while (loop);
				
				ROLE_B_channel_ROLE_A.Close();
				
				
			} catch (ClassCastException e) {
				AnBx_Debug.out(layer, "Message format type error - Program will be terminated!");
				e.printStackTrace();
				System.out.println(0);
			} catch (Exception e) {
				AnBx_Debug.out(layer, "Generic error - Program will be terminated!");
				e.printStackTrace();
				System.out.println(0);
			}
	};

	protected void executeStep(AnB_Session s, From_A_Secret_Steps step) {

		status(step);

		switch (step) {
		
		case STEP_0:
			
			VAR_B_R0 = (Crypto_SealedPair) s.Receive();
			eqCheck("0.1",aliases.get("ROLE_B"),(String) new AnBx_Params((AnBx_Params) s.verify((SignedObject) s.decrypt(VAR_B_R0),aliases.get("ROLE_A"))).getValue(0));

			break;

		
		default:
			break;		
		}

		status(step);

	}

	

	
	

}
